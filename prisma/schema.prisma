generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model auth_base_user {
  id             String                 @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  user_name      String?                @unique(map: "auth_base_user_pk") @db.VarChar(255)
  full_name      String?                @db.VarChar(255)
  email          String?                @db.VarChar(255)
  phone_number   String?                @db.Char(10)
  password_hash  String?                @db.VarChar(255)
  address        String?                @db.VarChar(255)
  description    String?                @db.VarChar(255)
  latest_login   DateTime?              @db.Timestamp(0)
  login_attempts Int?
  lockout_util   DateTime?              @db.Timestamp(0)
  status         auth_base_user_status? @default(INACTIVE)
  created_at     DateTime?              @default(now()) @db.Timestamp(0)
  updated_at     DateTime?              @default(now()) @db.Timestamp(0)
  group_id       String?                @db.VarChar(36)
  last_seen_at   DateTime?              @db.Timestamp(0)

  @@index([email], map: "idx_email")
  @@index([full_name], map: "idx_full_name")
  @@index([group_id], map: "idx_group_id")
  @@index([last_seen_at], map: "idx_last_seen")
  @@index([phone_number], map: "idx_phone_number")
  @@index([status], map: "idx_status")
}

model auth_group {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name        String?   @db.VarChar(255)
  description String?   @db.VarChar(255)
  type        String?   @db.VarChar(255)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@index([name], map: "idx_name")
  @@index([type], map: "idx_type")
}

model auth_impl_user_school {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  user_id     String?   @db.VarChar(36)
  school_id   String?   @db.VarChar(36)
  description String?   @db.Text
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@index([school_id], map: "idx_school_id")
  @@index([user_id], map: "idx_user_id")
  @@index([user_id, school_id], map: "idx_user_school")
}

model auth_impl_user_student {
  id             String                      @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  user_id        String?                     @db.VarChar(36)
  school_id      String?                     @db.VarChar(36)
  class_id       String?                     @db.VarChar(36)
  student_code   String?                     @db.VarChar(100)
  sex            auth_impl_user_student_sex?
  birthday       DateTime?                   @db.Date
  description    String?                     @db.Text
  major_interest String?                     @db.Text
  created_at     DateTime?                   @default(now()) @db.Timestamp(0)
  updated_at     DateTime?                   @default(now()) @db.Timestamp(0)

  @@index([birthday], map: "idx_birthday")
  @@index([class_id], map: "idx_class_id")
  @@index([school_id], map: "idx_school_id")
  @@index([sex], map: "idx_sex")
  @@index([student_code], map: "idx_student_code")
  @@index([user_id], map: "idx_user_id")
}

model auth_refresh_tokens {
  id         String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  token_id   String?   @unique(map: "token_id") @db.VarChar(255)
  token_hash String?   @db.VarChar(255)
  user_id    String?   @db.VarChar(36)
  expires_at DateTime? @db.Timestamp(0)
  revoked_at DateTime? @db.Timestamp(0)
  ip_address String?   @db.VarChar(45)
  user_agent String?   @db.Text
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)

  @@index([expires_at], map: "idx_expires")
  @@index([revoked_at], map: "idx_revoked")
  @@index([token_id], map: "idx_token_id")
  @@index([user_id], map: "idx_user")
  @@index([user_id, expires_at], map: "idx_user_expires")
}

model auth_role {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  group_id    String?   @db.VarChar(36)
  name        String?   @db.VarChar(255)
  description String?   @db.Text
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@index([group_id], map: "idx_group_id")
  @@index([group_id, name], map: "idx_group_name")
  @@index([name], map: "idx_name")
}

model classes {
  id                  String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name                String?   @db.VarChar(255)
  grade_level         Int?
  school_id           String?   @db.VarChar(36)
  homeroom_teacher_id String?   @db.VarChar(36)
  created_at          DateTime? @default(now()) @db.Timestamp(0)
  updated_at          DateTime? @default(now()) @db.Timestamp(0)

  @@index([grade_level], map: "idx_grade_level")
  @@index([homeroom_teacher_id], map: "idx_homeroom_teacher_id")
  @@index([name], map: "idx_name")
  @@index([school_id, grade_level], map: "idx_school_grade")
  @@index([school_id], map: "idx_school_id")
}

model commune {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name        String?   @db.VarChar(255)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)
  province_id String?   @db.VarChar(36)

  @@index([name], map: "idx_name")
}

model metadata {
  id             String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  bucket_name    String?   @db.VarChar(255)
  object_type    String?   @db.VarChar(255)
  object_id      String?   @db.VarChar(36)
  file_name      String?   @db.VarChar(255)
  file_path      String?   @db.VarChar(255)
  file_size      Int?
  mine_type      String?   @db.VarChar(255)
  file_extension String?   @db.VarChar(255)
  metadata       Json?
  upload_by      String?   @db.VarChar(36)
  created_at     DateTime? @default(now()) @db.Timestamp(0)
  updated_at     DateTime? @default(now()) @db.Timestamp(0)
}

model province {
  id         String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name       String?   @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)

  @@index([name], map: "idx_name")
}

model schools {
  id            String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name          String?   @db.VarChar(255)
  address       String?   @db.VarChar(255)
  contact_email String?   @db.VarChar(255)
  phone_number  String?   @db.VarChar(20)
  created_at    DateTime? @default(now()) @db.Timestamp(0)
  updated_at    DateTime? @default(now()) @db.Timestamp(0)

  @@index([contact_email], map: "idx_contact_email")
  @@index([name], map: "idx_name")
  @@index([phone_number], map: "idx_phone_number")
}

model student_logs {
  id         String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  student_id String?   @db.VarChar(36)
  type       String?   @db.VarChar(255)
  content    String?   @db.Text
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)

  @@index([created_at], map: "idx_created_at")
  @@index([student_id], map: "idx_student_id")
  @@index([student_id, type], map: "idx_student_type")
  @@index([type], map: "idx_type")
}

model system_setting {
  id            String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name_setting  String?   @unique(map: "system_setting_pk") @db.VarChar(255)
  value_setting String?   @db.VarChar(255)
  created_at    DateTime? @default(now()) @db.Timestamp(0)
  updated_at    DateTime? @default(now()) @db.Timestamp(0)
}

model career {
  id               String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  code             String?   @db.VarChar(10)
  name             String?   @db.VarChar(255)
  description      String?   @db.Text
  created_by_admin String?   @db.VarChar(36)
  tags             String?   @db.VarChar(255)
  is_active        Boolean?  @default(false)
  created_at       DateTime? @default(now()) @db.Timestamp(0)
  updated_at       DateTime? @default(now()) @db.Timestamp(0)
}

model career_criteria {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name        String?   @db.VarChar(255)
  description String?   @db.Text
  order_index Int?
  is_active   Boolean?  @default(false)
  career_id   String?   @db.VarChar(36)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)
}

model career_order_items {
  id         String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  order_id   String    @db.VarChar(36)
  career_id  String    @db.VarChar(36)
  price      Int?
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)
}

model career_orders {
  id          String                @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  order_code  Int                   @unique(map: "career_orders_pk") @default(autoincrement())
  school_id   String                @db.VarChar(36)
  create_by   String                @db.VarChar(36)
  status      career_orders_status? @default(PENDING)
  note        String?               @db.Text
  reviewed_by String?               @db.VarChar(36)
  reviewed_at DateTime?             @db.DateTime(0)
  created_at  DateTime?             @default(now()) @db.Timestamp(0)
  updated_at  DateTime?             @default(now()) @db.Timestamp(0)
}

model school_career_licenses {
  id            String                         @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  school_id     String                         @db.VarChar(36)
  career_id     String                         @db.VarChar(36)
  order_id      String                         @db.VarChar(36)
  order_item_id String                         @db.VarChar(36)
  start_date    DateTime?                      @db.DateTime(0)
  expiry_date   DateTime?                      @db.DateTime(0)
  status        school_career_licenses_status? @default(PENDING_ACTIVATION)
  created_at    DateTime?                      @default(now()) @db.Timestamp(0)
  updated_at    DateTime?                      @default(now()) @db.Timestamp(0)
}

model class_criteria_config {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  class_id    String?   @db.VarChar(36)
  career_id   String?   @db.VarChar(36)
  criteria_id String?   @db.VarChar(36)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)
}

model career_career_category {
  id                 String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  career_id          String?   @db.VarChar(36)
  career_category_id String?   @db.VarChar(36)
  created_at         DateTime? @default(now()) @db.Timestamp(0)
  updated_at         DateTime? @default(now()) @db.Timestamp(0)
}

model career_categories {
  id         String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name       String?   @db.VarChar(36)
  created_at DateTime? @default(now()) @db.Timestamp(0)
  updated_at DateTime? @default(now()) @db.Timestamp(0)
}


model question_categories {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  name        String    @db.VarChar(255)
  description String?   @db.Text
  parent_id   String?   @db.VarChar(36)
  order_index Int?
  created_by  String?   @db.VarChar(36)
  is_active   Boolean?  @default(true)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@index([parent_id], map: "idx_parent_id")
  @@index([created_by], map: "idx_created_by")
  @@index([is_active], map: "idx_is_active")
}

model questions {
  id                  String              @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  category_id         String?             @db.VarChar(36)
  career_criteria_id  String?             @db.VarChar(36)
  question_type       question_type?
  difficulty_level    question_difficulty?
  content             String              @db.Text
  options             Json?
  correct_answer      String?             @db.Text
  explanation         String?             @db.Text
  points              Decimal?            @default(1) @db.Decimal(5, 2)
  time_limit          Int?
  metadata            Json?
  tags                String?             @db.VarChar(500)
  usage_count         Int?                @default(0)
  created_by          String?             @db.VarChar(36)
  is_active           Boolean?            @default(true)
  created_at          DateTime?           @default(now()) @db.Timestamp(0)
  updated_at          DateTime?           @default(now()) @db.Timestamp(0)

  @@index([category_id], map: "idx_category_id")
  @@index([career_criteria_id], map: "idx_career_criteria_id")
  @@index([question_type], map: "idx_question_type")
  @@index([difficulty_level], map: "idx_difficulty_level")
  @@index([created_by], map: "idx_created_by")
  @@index([is_active], map: "idx_is_active")
  @@index([category_id, is_active], map: "idx_category_active")
}

model exams {
  id                        String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  title                     String    @db.VarChar(500)
  description               String?   @db.Text
  exam_code                 String?   @unique @db.VarChar(50)
  class_id                  String?   @db.VarChar(36)
  exam_type                 exam_type? @default(PRACTICE)
  duration_minutes          Int?
  total_points              Decimal?  @db.Decimal(6, 2)
  passing_score             Decimal?  @db.Decimal(6, 2)
  instructions              String?   @db.Text
  is_shuffle_questions      Boolean?  @default(false)
  is_shuffle_options        Boolean?  @default(false)
  show_results_immediately  Boolean?  @default(false)
  max_attempts              Int?
  start_time                DateTime? @db.DateTime(0)
  end_time                  DateTime? @db.DateTime(0)
  created_by                String?   @db.VarChar(36)
  is_published              Boolean?  @default(false)
  created_at                DateTime? @default(now()) @db.Timestamp(0)
  updated_at                DateTime? @default(now()) @db.Timestamp(0)

  @@index([exam_code], map: "idx_exam_code")
  @@index([class_id], map: "idx_class_id")
  @@index([exam_type], map: "idx_exam_type")
  @@index([created_by], map: "idx_created_by")
  @@index([is_published], map: "idx_is_published")
}

model exam_question_distributions {
  id                  String              @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  exam_id             String              @db.VarChar(36)
  category_id         String?             @db.VarChar(36)
  career_criteria_id  String?             @db.VarChar(36)
  question_type       question_type?
  difficulty_level    question_difficulty?
  quantity            Int
  easy_count          Int?                @default(0)
  medium_count        Int?                @default(0)
  hard_count          Int?                @default(0)
  points_per_question Decimal?            @default(1) @db.Decimal(5, 2)
  order_index         Int?
  created_at          DateTime?           @default(now()) @db.Timestamp(0)
  updated_at          DateTime?           @default(now()) @db.Timestamp(0)

  @@index([exam_id], map: "idx_exam_id")
  @@index([category_id], map: "idx_category_id")
  @@index([career_criteria_id], map: "idx_career_criteria_id")
  @@index([question_type], map: "idx_question_type")
  @@index([difficulty_level], map: "idx_difficulty_level")
  @@index([exam_id, order_index], map: "idx_exam_order")
}

model exam_questions {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  exam_id     String    @db.VarChar(36)
  question_id String    @db.VarChar(36)
  order_index Int
  points      Decimal?  @default(1) @db.Decimal(5, 2)
  created_at  DateTime? @default(now()) @db.Timestamp(0)

  @@unique([exam_id, question_id], map: "unique_exam_question")
  @@index([exam_id], map: "idx_exam_id")
  @@index([question_id], map: "idx_question_id")
  @@index([exam_id, order_index], map: "idx_exam_order")
}

model student_exam_attempts {
  id               String                       @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  student_id       String                       @db.VarChar(36)
  exam_id          String                       @db.VarChar(36)
  snapshot_data    Json?
  start_time       DateTime?                    @db.DateTime(0)
  submit_time      DateTime?                    @db.DateTime(0)
  duration_seconds Int?
  total_score      Decimal?                     @default(0) @db.Decimal(6, 2)
  max_score        Decimal?                     @db.Decimal(6, 2)
  status           student_exam_attempt_status? @default(IN_PROGRESS)
  is_auto_graded   Boolean?                     @default(false)
  graded_by        String?                      @db.VarChar(36)
  graded_at        DateTime?                    @db.DateTime(0)
  created_at       DateTime?                    @default(now()) @db.Timestamp(0)
  updated_at       DateTime?                    @default(now()) @db.Timestamp(0)

  @@index([student_id], map: "idx_student_id")
  @@index([exam_id], map: "idx_exam_id")
  @@index([status], map: "idx_status")
  @@index([student_id, exam_id], map: "idx_student_exam")
}

model student_answers {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  attempt_id  String    @db.VarChar(36)
  question_id String    @db.VarChar(36)
  answer_data Json?
  is_correct  Boolean?
  score       Decimal?  @default(0) @db.Decimal(5, 2)
  max_score   Decimal?  @db.Decimal(5, 2)
  feedback    String?   @db.Text
  graded_by   String?   @db.VarChar(36)
  graded_at   DateTime? @db.DateTime(0)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@unique([attempt_id, question_id], map: "unique_attempt_question")
  @@index([attempt_id], map: "idx_attempt_id")
  @@index([question_id], map: "idx_question_id")
  @@index([attempt_id, question_id], map: "idx_attempt_question")
}

model question_options {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  question_id String    @db.VarChar(36)
  option_key  String    @db.VarChar(10)
  option_text String    @db.Text
  is_correct  Boolean   @default(false)
  order_index Int?
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@index([question_id], map: "idx_question_id")
  @@index([question_id, order_index], map: "idx_question_order")
  }

model student_learn_progress {
  id                   String                         @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  student_id           String                         @db.VarChar(36)
  career_id            String                         @db.VarChar(36)
  criteria_id          String                         @db.VarChar(36)
  progress_percent     Float?                         @default(0)
  last_watched_positon Float?
  status               student_learn_progress_status? @default(WATCHING)
  created_at           DateTime?                      @default(now()) @db.Timestamp(0)
  updated_at           DateTime?                      @default(now()) @db.Timestamp(0)

}

enum auth_impl_user_student_sex {
  MALE   @map("1")
  FEMALE @map("2")
}

enum auth_base_user_status {
  ACTIVE
  INACTIVE
  BANNER
}

enum career_orders_status {
  PENDING
  REJECTED
  APPROVED
}

enum school_career_licenses_status {
  ACTIVE
  EXPIRED
  REVOKED
  PENDING_ACTIVATION
}


enum question_type {
  MULTIPLE_CHOICE
  TRUE_FALSE
  SHORT_ANSWER
  ESSAY
}

enum question_difficulty {
  EASY
  MEDIUM
  HARD
}

enum exam_type {
  PRACTICE
  QUIZ
  MIDTERM
  FINAL
  MOCK_TEST
}

enum student_exam_attempt_status {
  IN_PROGRESS
  SUBMITTED
  GRADED
}

// ============================================
// CAREER EVALUATION SYSTEM
// ============================================

// Cấu hình trọng số tiêu chí theo lớp
model class_criteria_weights {
  id          String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  class_id    String    @db.VarChar(36)
  career_id   String    @db.VarChar(36)
  criteria_id String    @db.VarChar(36)
  weight      Int       // Trọng số (0-100%), VD: 20 = 20%
  created_by  String?   @db.VarChar(36)
  created_at  DateTime? @default(now()) @db.Timestamp(0)
  updated_at  DateTime? @default(now()) @db.Timestamp(0)

  @@unique([class_id, career_id, criteria_id], map: "unique_class_career_criteria")
  @@index([class_id, career_id], map: "idx_class_career")
  @@index([criteria_id], map: "idx_criteria")
}

// Ngưỡng đánh giá nghề nghiệp theo lớp
model career_evaluation_thresholds {
  id                  String    @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  class_id            String    @db.VarChar(36)
  career_id           String    @db.VarChar(36)
  
  // Điểm tối đa = Số tiêu chí × 10
  // VD: 5 tiêu chí → max_score = 50, 10 tiêu chí → max_score = 100
  max_score           Float     // Tự động tính hoặc cấu hình
  
  // Ngưỡng phân loại (giá trị tuyệt đối)
  very_suitable_min   Float     // VD: >= 40/50 hoặc >= 80/100
  suitable_min        Float     // VD: >= 30/50 hoặc >= 60/100
  // < suitable_min = Không phù hợp
  
  created_by          String?   @db.VarChar(36)
  created_at          DateTime? @default(now()) @db.Timestamp(0)
  updated_at          DateTime? @default(now()) @db.Timestamp(0)

  @@unique([class_id, career_id], map: "unique_class_career_threshold")
  @@index([class_id], map: "idx_class")
  @@index([career_id], map: "idx_career")
}

// Kết quả đánh giá nghề nghiệp của học sinh
model student_career_evaluations {
  id                String                   @id @default(dbgenerated("(uuid())")) @db.VarChar(36)
  student_id        String                   @db.VarChar(36)
  class_id          String                   @db.VarChar(36)
  career_id         String                   @db.VarChar(36)
  
  // Điểm thô học sinh tự đánh giá
  // Format: [{ criteria_id: "TC1", score: 8 }, { criteria_id: "TC2", score: 6 }, ...]
  raw_scores        Json                     
  
  // Kết quả tính toán
  weighted_score    Float                    // Điểm sau khi áp dụng trọng số
  max_score         Float                    // Điểm tối đa (số tiêu chí × 10)
  percentage        Float                    // % = (weighted_score / max_score) × 100
  
  // Kết quả đánh giá
  evaluation_result evaluation_result_type?  @default(NOT_SUITABLE)
  
  // Metadata
  notes             String?                  @db.Text
  evaluated_at      DateTime?                @default(now()) @db.Timestamp(0)
  created_at        DateTime?                @default(now()) @db.Timestamp(0)
  updated_at        DateTime?                @default(now()) @db.Timestamp(0)

  @@unique([student_id, career_id, class_id], map: "unique_student_career_class")
  @@index([student_id], map: "idx_student")
  @@index([career_id], map: "idx_career_eval")
  @@index([class_id, career_id], map: "idx_class_career_eval")
  @@index([evaluation_result], map: "idx_eval_result")
}

enum evaluation_result_type {
  VERY_SUITABLE    // Rất phù hợp
  SUITABLE         // Phù hợp
  NOT_SUITABLE     // Không phù hợp
}
enum student_learn_progress_status {
  WATCHING
  PAUSED
  SEEK_ATTEMPT
  COMPLETED
  EXIT
}
